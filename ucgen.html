<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triangular Chip Game</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #game-container {
            position: relative; /* For context menu positioning */
        }
        #game-grid {
            background-color: #333;
            border: 1px solid #555;
        }
        .triangle-cell {
            cursor: pointer;
            transition: fill 0.2s;
        }
        .triangle-cell:hover {
            opacity: 0.8;
        }
        .chip-text {
            font-size: 16px;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none; /* So text doesn't interfere with triangle click */
        }
        #context-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 8px;
            z-index: 100;
            border-radius: 4px;
        }
        #context-menu button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            background-color: #efefef;
            cursor: pointer;
        }
        #context-menu button:last-child {
            margin-bottom: 0;
        }
        #context-menu button:hover {
            background-color: #e0e0e0;
        }
        #instructions {
            margin-bottom: 20px;
            padding: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-width: 700px;
        }
    </style>
</head>
<body>
    <h1>Triangular Chip Game</h1>
    <div id="instructions">
        <p>Click on any triangle cell to interact:</p>
        <ul>
            <li><b>Add 2 Chips:</b> Adds two chips to the cell.</li>
            <li><b>Remove 2 Chips:</b> Removes two chips (if present).</li>
            <li><b>Fire Chip:</b> Removes one chip from the cell and adds one chip to each of its 3 edge-adjacent neighbors.</li>
        </ul>
        <p>The game starts with 1 chip in the middle.</p>
    </div>

    <div id="game-container">
        <svg id="game-grid" width="850" height="850"></svg> {/* <-- MODIFIED SVG SIZE --> */}
        <div id="context-menu">
            <button id="btnAdd2">Add 2 Chips</button>
            <button id="btnRemove2">Remove 2 Chips</button>
            <button id="btnFire">Fire Chip</button>
        </div>
    </div>

    <script>
        const svgNS = "http://www.w3.org/2000/svg";
        const gameGridSvg = document.getElementById('game-grid');
        const contextMenu = document.getElementById('context-menu');
        const btnAdd2 = document.getElementById('btnAdd2');
        const btnRemove2 = document.getElementById('btnRemove2');
        const btnFire = document.getElementById('btnFire');

        const TRIANGLE_SIDE_LENGTH = 50;
        const TRIANGLE_HEIGHT = TRIANGLE_SIDE_LENGTH * Math.sqrt(3) / 2;
        const TRIANGLE_WIDTH_HALF = TRIANGLE_SIDE_LENGTH / 2;

        const GRID_ROWS = 18; // <-- MODIFIED: Number of rows of triangle *bases*
        const GRID_COLS = 30; // <-- MODIFIED: Number of triangle *half-widths*

        const C_X_OFFSET = 10; // Offset from SVG left edge
        const C_Y_OFFSET = 10; // Offset from SVG top edge

        let chips = {}; // Store chips as {"row,col": count}

        let activeCell = null; // For context menu actions {r, c}

        // --- Chip Management ---
        function getChipCount(r, c) {
            return chips[`${r},${c}`] || 0;
        }

        function setChipCount(r, c, count) {
            if (count > 0) {
                chips[`${r},${c}`] = count;
            } else {
                delete chips[`${r},${c}`];
            }
        }

        function addChips(r, c, amount) {
            setChipCount(r, c, getChipCount(r, c) + amount);
        }

        // --- Game Logic ---
        function performAdd2Chips(r, c) {
            addChips(r, c, 2);
            drawGrid();
        }

        function performRemove2Chips(r, c) {
            const currentChips = getChipCount(r, c);
            if (currentChips >= 2) {
                addChips(r, c, -2);
            } else {
                setChipCount(r, c, 0);
            }
            drawGrid();
        }

        function performFireChip(r, c) {
            if (getChipCount(r, c) < 1) return;

            addChips(r, c, -1); // Remove one chip from current cell

            const isUp = (r + c) % 2 === 0;
            let neighbors = [];

            if (isUp) {
                // Adjacent cells are DOWN-pointing
                neighbors = [
                    { r: r, c: c - 1 },     // Left
                    { r: r, c: c + 1 },     // Right
                    { r: r + 1, c: c }      // Bottom
                ];
            } else {
                // Adjacent cells are UP-pointing
                neighbors = [
                    { r: r, c: c - 1 },     // Left
                    { r: r, c: c + 1 },     // Right
                    { r: r - 1, c: c }      // Top
                ];
            }

            neighbors.forEach(n => {
                // Ensure neighbors are within drawn bounds for this demo, though chip data could be "infinite"
                if (n.r >= 0 && n.r < GRID_ROWS && n.c >= 0 && n.c < GRID_COLS) {
                     addChips(n.r, n.c, 1);
                } else {
                    // For a truly infinite grid, we'd just add them.
                    addChips(n.r, n.c, 1);
                }
            });
            drawGrid();
        }

        // --- Drawing ---
        function createSvgElement(tag, attributes) {
            const el = document.createElementNS(svgNS, tag);
            for (const attr in attributes) {
                el.setAttribute(attr, attributes[attr]);
            }
            return el;
        }

        function drawGrid() {
            gameGridSvg.innerHTML = ''; // Clear previous grid

            for (let r = 0; r < GRID_ROWS; r++) {
                for (let c = 0; c < GRID_COLS; c++) {
                    const isUp = (r + c) % 2 === 0; // UP if (r+c) is even, DOWN if odd

                    const x_base = C_X_OFFSET + c * TRIANGLE_WIDTH_HALF;
                    const y_base = C_Y_OFFSET + r * TRIANGLE_HEIGHT;

                    let points = "";
                    let centerX, centerY;

                    if (isUp) {
                        points = `${x_base + TRIANGLE_WIDTH_HALF},${y_base} ${x_base},${y_base + TRIANGLE_HEIGHT} ${x_base + TRIANGLE_SIDE_LENGTH},${y_base + TRIANGLE_HEIGHT}`;
                        centerX = x_base + TRIANGLE_WIDTH_HALF;
                        centerY = y_base + TRIANGLE_HEIGHT * (2/3);
                    } else {
                        points = `${x_base},${y_base} ${x_base + TRIANGLE_SIDE_LENGTH},${y_base} ${x_base + TRIANGLE_WIDTH_HALF},${y_base + TRIANGLE_HEIGHT}`;
                        centerX = x_base + TRIANGLE_WIDTH_HALF;
                        centerY = y_base + TRIANGLE_HEIGHT * (1/3);
                    }

                    const triangle = createSvgElement('polygon', {
                        points: points,
                        fill: isUp ? '#6fa8dc' : '#3d85c6',
                        stroke: '#222',
                        'stroke-width': 1,
                        class: 'triangle-cell'
                    });

                    triangle.dataset.r = r;
                    triangle.dataset.c = c;

                    triangle.addEventListener('click', (event) => {
                        activeCell = { r: parseInt(triangle.dataset.r), c: parseInt(triangle.dataset.c) };
                        const rect = gameGridSvg.getBoundingClientRect();
                        contextMenu.style.left = `${event.clientX - rect.left + 10}px`;
                        contextMenu.style.top = `${event.clientY - rect.top + 10}px`;
                        contextMenu.style.display = 'block';

                        btnFire.disabled = getChipCount(activeCell.r, activeCell.c) < 1;
                        btnRemove2.disabled = getChipCount(activeCell.r, activeCell.c) < 2;
                    });

                    gameGridSvg.appendChild(triangle);

                    const chipCount = getChipCount(r, c);
                    if (chipCount > 0) {
                        const chipCircle = createSvgElement('circle', {
                            cx: centerX,
                            cy: centerY,
                            r: TRIANGLE_SIDE_LENGTH / 4,
                            fill: 'lightskyblue',
                            stroke: 'blue',
                            'stroke-width': 2,
                            'pointer-events': 'none'
                        });
                        gameGridSvg.appendChild(chipCircle);

                        const text = createSvgElement('text', {
                            x: centerX,
                            y: centerY,
                            class: 'chip-text'
                        });
                        text.textContent = chipCount;
                        gameGridSvg.appendChild(text);
                    }
                }
            }
        }

        // --- Context Menu Event Handling ---
        btnAdd2.addEventListener('click', () => {
            if (activeCell) performAdd2Chips(activeCell.r, activeCell.c);
            contextMenu.style.display = 'none';
        });
        btnRemove2.addEventListener('click', () => {
            if (activeCell) performRemove2Chips(activeCell.r, activeCell.c);
            contextMenu.style.display = 'none';
        });
        btnFire.addEventListener('click', () => {
            if (activeCell) performFireChip(activeCell.r, activeCell.c);
            contextMenu.style.display = 'none';
        });

        document.addEventListener('click', (event) => {
            if (!contextMenu.contains(event.target) && event.target.tagName !== 'polygon') {
                contextMenu.style.display = 'none';
            }
        });

        // --- Initialization ---
        function initializeBoard() {
            chips = {}; // Clear any previous chips

            // Calculate a central position
            const middleR = Math.floor(GRID_ROWS / 2);
            let middleC = Math.floor(GRID_COLS / 2);

            // Aim for an UP-pointing triangle (r+c is even) for the central chip
            // For GRID_ROWS = 18, middleR = 9
            // For GRID_COLS = 30, middleC = 15
            // (9 + 15) = 24, which is even. So (9,15) is an UP triangle.
            if ((middleR + middleC) % 2 !== 0) {
                // If (middleR + middleC) is odd, it's a DOWN triangle.
                // Adjust middleC to make it an UP triangle, e.g., by shifting one column.
                // This usually makes it visually more "centered" if the grid has an even number of columns.
                middleC -=1;
                if (middleC < 0) middleC = 1; // prevent negative column if GRID_COLS is very small
            }

            chips[`${middleR},${middleC}`] = 1;
            drawGrid();
        }

        initializeBoard();

    </script>
</body>
</html>